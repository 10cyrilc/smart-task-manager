name: Build & Release APK

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # Required to access previous tags

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Decode env.json
        run: echo "$ENV_JSON" | base64 -d > env.json
        env:
          ENV_JSON: ${{ secrets.ENV_JSON }}

      - name: Decode google-services.json
        run: echo "$GOOGLE_SERVICES" | base64 -d > android/app/google-services.json
        env:
          GOOGLE_SERVICES: ${{ secrets.GOOGLE_SERVICES }}

      - name: Install dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release --dart-define-from-file=env.json

      # Generate clean release notes
      - name: Generate Release Notes
        id: notes
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s")
          else
            COMMITS=$(git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s")
          fi

          CLEAN_COMMITS=$(echo "$COMMITS" | grep -vE "Merge pull request|Merge branch")

          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          echo "$CLEAN_COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: ${{ steps.notes.outputs.RELEASE_NOTES }}
          files: build/app/outputs/flutter-apk/app-release.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}